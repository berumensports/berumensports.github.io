rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {
    function signedIn() { return request.auth != null; }
    function isAdmin() {
      return signedIn() &&
        exists(/databases/$(db)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(db)/documents/users/$(request.auth.uid)).data.role == "admin";
    }
    function isTorneo(doc) { return !('torneoId' in doc) || (doc.torneoId is string && doc.torneoId.size() > 0); }
    function isTemp(doc) { return !('tempId' in doc) || doc.tempId == "2025"; }

    match /users/{uid} {
      allow read: if signedIn();
      allow write: if signedIn() && request.auth.uid == uid;
    }

    // Allow all authenticated users to create diagnostic entries
    match /diagnostics/{id} {
      allow read: if signedIn() && isTorneo(resource.data) && isTemp(resource.data);
      allow create: if signedIn() && isTorneo(request.resource.data) && isTemp(request.resource.data);
      // Only admins can modify or delete diagnostics
      allow update, delete: if signedIn() && isAdmin() && isTorneo(resource.data) && isTemp(resource.data);
    }

    match /{coll}/{id} {
      allow read: if signedIn() && isTorneo(resource.data) && isTemp(resource.data);
      allow create: if signedIn() && isAdmin() && isTorneo(request.resource.data) && isTemp(request.resource.data);
      allow update, delete: if signedIn() && isAdmin() && isTorneo(resource.data) && isTemp(resource.data);
    }
  }
}
